name: StegBrain (advisory)

on:
  issues:
    types: [opened, edited]
  pull_request:
    types: [opened, synchronize]
    paths:
      - "**/*.json"

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  stegbrain:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout this repo
        uses: actions/checkout@v4

      - name: Checkout StegBrain
        uses: actions/checkout@v4
        with:
          repository: StegVerse-labs/StegBrain
          path: stegbrain-lib

      - name: Checkout DiamondOps-Core
        uses: actions/checkout@v4
        with:
          repository: StegVerse-labs/DiamondOps-Core
          path: core

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: pip install jsonschema

      - name: Run StegBrain (build comment)
        run: |
          STEGBRAIN_VERSION="$(cat stegbrain-lib/VERSION 2>/dev/null || echo 0.1.0)"
          echo "StegBrain: $STEGBRAIN_VERSION"
          python stegbrain-lib/stegbrain/run_github.py
        env:
          REPO_ROOT: .
          CORE_DIR: ./core
          CORE_VERSION: v0.3.x
          STEGBRAIN_VERSION: 0.1.0
          OUTPUT_PATH: ./stegbrain_output.json

      - name: Post comment (Issue or PR)
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const payload = JSON.parse(fs.readFileSync('./stegbrain_output.json', 'utf8'));
            const body = payload.comment;

            if (context.eventName === 'issues') {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.issue.number,
                body
              });
              return;
            }

            if (context.eventName === 'pull_request') {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body
              });
              return;
            }
